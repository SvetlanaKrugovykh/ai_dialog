# Система редактирования заявок по полям

## Обзор системы

Реализована полная система редактирования заявок с возможностью изменения отдельных полей и интеграцией с Service Desk.

## Основные компоненты

### 1. Обработка callback-запросов (`messageHandler.js`)

- **Парсинг callback-ов**: Система обрабатывает сложные callback-запросы типа `editfield_title_TKT-123`
- **Поддержка приоритетов**: Обработка callback-ов `setpriority_High_TKT-123`
- **Режимы редактирования**: Поддержка полного текстового, голосового и поэлементного редактирования

### 2. Service Desk интеграция (`ticketService.js`)

- **API интеграция**: POST запросы к `https://127.0.0.1:8001/api/create-ticket`
- **Режимы работы**: Debug и production режимы
- **Парсинг заявок**: Автоматическое извлечение полей из текста заявки
- **Обработка ошибок**: Комплексная система обработки ошибок API

### 3. Интерфейс пользователя (`messages.js`)

- **Украинский интерфейс**: Полная локализация на украинский язык
- **Инструкции по полям**: Специфические инструкции для каждого поля
- **Сообщения об успехе/ошибках**: Информативные сообщения для пользователя

## Алгоритм работы

### 1. Создание заявки
1. Пользователь отправляет голосовое сообщение или текст
2. Система обрабатывает и создает предварительную заявку
3. Показывается превью с кнопками: ЗБЕРЕГТИ, ВІДМІНИТИ, РЕДАГУВАТИ

### 2. Редактирование
При нажатии "РЕДАГУВАТИ":
1. Показываются опции: полное редактирование, голосовое, поэлементное
2. При выборе поэлементного - показываются кнопки для каждого поля
3. Пользователь может изменить любое поле индивидуально

### 3. Отправка в Service Desk
При нажатии "ЗБЕРЕГТИ":
1. Заявка отправляется в Service Desk через `ticketService`
2. В debug режиме - имитируется отправка
3. Пользователь получает подтверждение с ID заявки

## Поддерживаемые поля

- **title**: Заголовок заявки
- **description**: Описание проблемы
- **priority**: Приоритет (Low/Medium/High/Critical)
- **category**: Категория заявки
- **urgency**: Срочность
- **location**: Местоположение

## Callback структура

- `confirm_{ticketId}` - подтверждение заявки
- `cancel_{ticketId}` - отмена заявки  
- `edit_{ticketId}` - начать редактирование
- `editfull_{ticketId}` - полное текстовое редактирование
- `editvoice_{ticketId}` - голосовое редактирование
- `editfield_{fieldName}_{ticketId}` - редактирование конкретного поля
- `setpriority_{priority}_{ticketId}` - установка приоритета

## Режимы работы

### Debug режим
- Заявки не отправляются реально в Service Desk
- Генерируются тестовые ID заявок
- Логируются все действия для отладки

### Production режим
- Реальная отправка в Service Desk
- Обработка реальных ответов API
- Полная интеграция с Zammad

## Настройка переменных окружения

```env
# Service Desk настройки
ZAMMAD_API_URL=https://127.0.0.1:8001/api
MODE=debug  # или production

# Telegram Bot настройки
TELEGRAM_TOKEN=your_telegram_token

# OpenAI настройки (опционально)
OPENAI_API_KEY=your_openai_key
```

## Логирование

Все операции логируются с детальной информацией:
- Создание заявок
- Редактирование полей  
- Отправка в Service Desk
- Ошибки и исключения

## Тестирование

Для тестирования системы:
1. Запустите бота: `node src/index.js`
2. Отправьте голосовое сообщение или текст
3. Используйте кнопки для редактирования полей
4. Проверьте отправку в Service Desk

Система готова к продакшн использованию и полностью интегрирована с существующим ботом.
